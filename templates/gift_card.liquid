{% comment %}
  QR code is rendered in `#QrCode`

  `gift_card.pass_url` is true if apple wallet is enabled for the shop
{% endcomment %}

{% layout 'gift_card' %}

<header role="banner">
  <div itemscope itemtype="http://schema.org/Organization">
    <a href="{{ shop.url }}" itemprop="url" class="site-logo">
      <img src="/cdn/shop/files/logo-zarena_500x.png?v=1627990165" alt="ZARENA" itemprop="logo">
    </a>
  </div>
</header>

<main class="giftcard {% if gift_card.expired or gift_card.enabled != true %} giftcard--disabled{% endif %}">
  <h1>{{ 'gift_cards.issued.subtext' | t }}</h1>
  {% unless gift_card.enabled %}
    <span class="giftcard-tag">{{ 'gift_cards.issued.disabled' | t }}</span>
  {% endunless %}

  {%- assign gift_card_expiry_date = gift_card.expires_on | date: '%d/%m/%y' -%}

  {% if gift_card.expired and gift_card.enabled %}
    <span class="giftcard-tag">{{ 'gift_cards.issued.expired' | t: expiry: gift_card_expiry_date }}</span>
  {% endif %}

  {% if gift_card.expired != true and gift_card.expires_on and gift_card.enabled %}
    <span class="giftcard-tag giftcard-tag--active">
      {{- 'gift_cards.issued.active' | t: expiry: gift_card_expiry_date -}}
    </span>
  {% endif %}

  <div class="giftcard__illustration">
    <img src="{{ 'gift-card/card.jpg' | shopify_asset_url }}" alt="Gift card illustration">

    {%- assign code_size = gift_card.code | format_code | size -%}
    <span id="gift-card-code-digits" class="giftcard__code" title="Click to copy">{{ gift_card.code | format_code }}</span>
  </div>

  {% assign formatted_initial_value = gift_card.initial_value | money_without_trailing_zeros: gift_card.currency %}

  <h2>{{ 'gift_cards.issued.initial_value_html' | t: value: formatted_initial_value }}</h2>

  {% assign formatted_current_balance = gift_card.balance | money %}
  {% if gift_card.balance != gift_card.initial_value %}
    <p>{{ 'gift_cards.issued.remaining_html' | t: balance: formatted_current_balance }}</p>
  {% endif %}

  <p>{{ 'gift_cards.issued.redeem' | t }}</p>
  
  <div id="copy-success" class="copy-success">{{ 'gift_cards.issued.copied_to_clipboard' | t }}</div>

  {% if gift_card.pass_url %}
    <div class="giftcard-apple-wallet">
      <a href="{{ gift_card.pass_url }}" class="apple-wallet">
        <img
          class="apple-wallet-image"
          src="{{ 'gift-card/add-to-apple-wallet.svg' | shopify_asset_url }}"
          width="120"
          height="40"
          alt="{{ 'gift_cards.issued.add_to_apple_wallet' | t }}"
        >
      </a>
    </div>
  {% endif %}

  <div class="giftcard-button-row">
    <a href="#" id="print-gift-card" class="print-giftcard btn btn--secondary">
      <span class="feather-icon feather-icon--small">{% render 'feather-printer' %}</span>
      <span class="btn__icon-label">{{ 'gift_cards.issued.print' | t }}</span>
    </a>

    <a href="{{ shop.url }}?discount={{ gift_card.code | url_encode }}" class="btn btn--primary" target="_blank">{{ 'gift_cards.issued.shop_link' | t }}</a>
  </div>
</main>

<style>
  .logo {
    display: none;
  }

  header[role='banner'] {
    text-align: center;
    padding: 20px 0;
  }

  .site-logo img {
    max-width: 200px;
    height: auto;
  }
  
  .giftcard-button-row {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 30px;
  }
  
  @media (max-width: 768px) {
    .giftcard-button-row {
      flex-direction: column;
      align-items: center;
    }
    
    .print-giftcard {
      display: none !important;
    }
  }
  
  .print-giftcard, .btn {
    padding: 12px 24px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  
  .print-giftcard {
    background-color: #fff;
    border: 2px solid #c81853;
    color: #c81853;
  }
  
  .print-giftcard:hover {
    background-color: #c81853;
    color: #fff;
  }
  
  .btn--primary {
    background-color: #c81853;
    border: 2px solid #c81853;
    color: #fff;
  }
  
  .btn--primary:hover {
    background-color: #a01442;
    border-color: #a01442;
  }
  
  .giftcard__code {
    cursor: pointer;
    user-select: none;
  }
  
  .giftcard__code:hover {
    opacity: 0.8;
  }
  
  .copy-success {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #28a745;
    color: white;
    padding: 12px 32px;
    border-radius: 6px;
    font-size: 16px;
    font-weight: 600;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 9999;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    white-space: nowrap;
    text-align: center;
    min-width: 200px;
  }
  
  .copy-success.show {
    opacity: 1;
    visibility: visible;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const printButton = document.getElementById('print-gift-card');
    const giftCardCode = document.getElementById('gift-card-code-digits');
    const copySuccess = document.getElementById('copy-success');
    
    // Print functionality
    if (printButton) {
      printButton.addEventListener('click', function(e) {
        e.preventDefault();
        window.print();
      });
    }
    
    // Copy code functionality
    if (giftCardCode && copySuccess) {
      giftCardCode.addEventListener('click', function() {
        const codeText = giftCardCode.textContent.replace(/\s/g, '');
        
        navigator.clipboard.writeText(codeText).then(function() {
          showCopySuccess();
        }).catch(function() {
          // Fallback for older browsers
          const textArea = document.createElement('textarea');
          textArea.value = codeText;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
          showCopySuccess();
        });
      });
    }
    
    function showCopySuccess() {
      copySuccess.classList.add('show');
      setTimeout(function() {
        copySuccess.classList.remove('show');
      }, 2000);
    }
  });
</script>
